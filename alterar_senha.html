<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redefinir Senha | AmbIn</title>
  <link rel="shortcut icon" href="assets/images/logo/LogoIcon.png" type="image/x-icon" />
  <link rel="stylesheet" href="assets/css/animate.css" />
  <link rel="stylesheet" href="assets/css/tailwind.css" />

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <script>
    // Variáveis globais para Supabase
    let supabase;

    document.addEventListener('DOMContentLoaded', () => {
      // Inicialização do Supabase
      const SUPABASE_URL = "https://qlhbieemfchehmheqxip.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsaGJpZWVtZmNoZWhtaGVxeGlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA2MDMxMTIsImV4cCI6MjA0NjE3OTExMn0.E1eVfPSlm0P8N23T7YkkeVVFB1jyBB92Y_w6UnyAbHE";
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      async function alterarSenha() {
        const otpCode = document.getElementById('otpCode').value;
        const novaSenha = document.getElementById('novaSenha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;
        const mensagemStatus = document.getElementById('mensagemStatus');

        mensagemStatus.textContent = ''; // Limpa a mensagem anterior

        if (novaSenha !== confirmarSenha) {
          mensagemStatus.textContent = 'As senhas não coincidem.';
          mensagemStatus.style.color = 'red';
          return;
        }

        try {
          // Usa o código OTP para redefinir a senha
          const { error } = await supabase.auth.verifyOtp({
            type: 'recovery',
            token: otpCode,
            password: novaSenha
          });

          if (error) {
            mensagemStatus.textContent = 'Erro ao redefinir senha: ' + error.message;
            mensagemStatus.style.color = 'red';
          } else {
            mensagemStatus.textContent = 'Senha alterada com sucesso! Você será redirecionado para a página de login.';
            mensagemStatus.style.color = 'green';
            setTimeout(() => {
              window.location.href = 'signin.html';
            }, 3000);
          }
        } catch (error) {
          console.error('Erro inesperado:', error);
          mensagemStatus.textContent = 'Erro inesperado: ' + error.message;
          mensagemStatus.style.color = 'red';
        }
      }

      // Verifica se o botão existe antes de adicionar o event listener
      const alterarSenhaButton = document.getElementById("alterarSenhaButton");
      if (alterarSenhaButton) {
        alterarSenhaButton.addEventListener("click", alterarSenha);
      } else {
        console.error("O botão de alterar senha não foi encontrado.");
      }
    });
  </script>
</head>

<body>
  <div class="ud-header left-0 top-0 z-40 flex w-full items-center bg-transparent lg:mb-32 mb-20">
    <div class="container">
      <div class="relative -mx-4 flex items-center justify-between">
        <div class="w-60 max-w-full px-4">
          <a href="index.html" class="navbar-logo block w-full py-5">
            <img src="assets/images/logo/AmbinLogo.png" alt="logo" class="header-logo w-full" />
          </a>
        </div>
        <div class="flex items-center justify-end">
          <a href="signin.html" class="loginBtn px-[22px] py-2 text-base font-medium text-black hover:opacity-70">Entrar</a>
        </div>
      </div>
    </div>
  </div>

  <section class="bg-[#F4F7FF] py-14 lg:py-[90px] dark:bg-dark lg:mt-20 mt-10">
    <div class="container">
      <div class="flex flex-wrap -mx-4">
        <div class="w-full px-4">
          <div class="wow fadeInUp relative mx-auto max-w-[525px] overflow-hidden rounded-lg bg-white dark:bg-dark-2 py-14 px-8 text-center sm:px-12 md:px-[60px]" data-wow-delay=".15s">
            <div class="mb-10 text-center">
              <a href="javascript:void(0)" class="mx-auto inline-block max-w-[160px]">
                <img src="assets/images/logo/AmbinLogo.png" alt="logo" class="dark:hidden" />
                <img src="assets/images/logo/AmbinLogo.png" alt="logo" class="hidden dark:block" />
              </a>
            </div>
            <form id="novaSenhaForm">
              <div class="mb-[22px]">
                <input type="text" id="otpCode" placeholder="Código de Verificação" class="w-full px-5 py-3" required />
              </div>
              <div class="mb-[22px]">
                <input type="password" id="novaSenha" placeholder="Nova Senha" class="w-full px-5 py-3" required />
              </div>
              <div class="mb-[22px]">
                <input type="password" id="confirmarSenha" placeholder="Confirmar Senha" class="w-full px-5 py-3" required />
              </div>
              <div class="mb-9">
                <button type="button" id="alterarSenhaButton" class="w-full px-5 py-3 text-white bg-primary">
                  Alterar Senha
                </button>
              </div>
              <p id="mensagemStatus" class="text-red-500"></p>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
</body>

</html>
